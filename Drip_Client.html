<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ========== ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶Æ‡ßá‡¶ü‡¶æ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó (‡¶Æ‡ßÇ‡¶≤ ‡¶∏‡¶æ‡¶á‡¶ü ‡¶•‡ßá‡¶ï‡ßá) ========== -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval'; img-src 'self' https: data:; font-src 'self' https: data:; style-src 'self' https: 'unsafe-inline'; script-src 'self' https: 'unsafe-inline' 'unsafe-eval';">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="format-detection" content="telephone=no, address=no, email=no">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>Admin Panel - Platform Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
                "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js"
            }
        }
    </script>
    <style>
        .hidden { display: none !important; }
        .tab-active { background-color: #3b82f6; color: white; }
        .platform-tab { padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .platform-tab:hover { background-color: #e5e7eb; }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <!-- Login Card -->
    <div id="loginCard" class="max-w-md mx-auto mt-20 bg-white rounded-xl shadow-lg p-8">
        <h2 class="text-2xl font-bold text-center mb-6">üîê Admin Login</h2>
        <div class="space-y-4">
            <button id="googleLoginBtn" class="w-full bg-red-500 text-white py-2 rounded-lg flex items-center justify-center gap-2">
                <i class="fab fa-google"></i> Sign in with Google
            </button>
            <p id="loginError" class="text-sm text-red-500 text-center"></p>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="max-w-6xl mx-auto hidden space-y-6">
        <div class="bg-white rounded-xl shadow-md p-6 flex justify-between items-center">
            <h1 class="text-2xl font-bold"><i class="fas fa-crown text-yellow-500 mr-2"></i>Platform Admin Panel</h1>
            <div class="flex items-center gap-4">
                <span id="userEmail" class="text-sm text-gray-600"></span>
                <button id="logoutBtn" class="bg-gray-600 text-white px-5 py-2 rounded-lg">Logout</button>
            </div>
        </div>

        <!-- Platform Tabs -->
        <div class="bg-white rounded-xl shadow-md p-4">
            <div class="flex flex-wrap gap-2">
                <button class="platform-tab tab-active" data-platform="drip">Drip Client</button>
                <button class="platform-tab" data-platform="hg">HG Cheats</button>
                <button class="platform-tab" data-platform="dark">Dark Patch</button>
                <button class="platform-tab" data-platform="pato">Pato Team</button>
            </div>
        </div>

        <!-- Settings Section (Platform Specific) -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-cog text-blue-500 mr-2"></i><span id="currentPlatform">Drip Client</span> Settings</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Video Link</label>
                    <input type="url" id="videoLink" placeholder="https://youtu.be/..." class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Download Link</label>
                    <input type="url" id="downloadLink" placeholder="https://t.me/..." class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Redirect Base URL</label>
                    <input type="url" id="redirectBase" placeholder="https://t.me/yourchannel?start=" class="w-full px-3 py-2 border rounded-lg">
                </div>
            </div>
            <button id="saveSettings" class="mt-4 bg-green-600 text-white px-5 py-2 rounded-lg">Save Settings</button>
            <p id="settingsMessage" class="text-sm mt-2"></p>
        </div>

        <!-- Products Section -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex justify-between mb-4">
                <h2 class="text-xl font-semibold"><i class="fas fa-boxes text-purple-500 mr-2"></i><span id="currentPlatformProducts">Drip Client</span> Products</h2>
                <button id="addProductBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg">+ New Product</button>
            </div>

            <!-- Product Form -->
            <div id="productForm" class="hidden bg-gray-50 border rounded-lg p-4 mb-4">
                <h3 id="formTitle" class="font-medium mb-3">‚ûï Add Product</h3>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
                    <div>
                        <label class="block text-xs text-gray-600">Name</label>
                        <input type="text" id="prodName" class="w-full px-3 py-2 border rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600">Price (‡ß≥)</label>
                        <input type="number" id="prodPrice" class="w-full px-3 py-2 border rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600">Order</label>
                        <input type="number" id="prodOrder" class="w-full px-3 py-2 border rounded text-sm" value="0">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600">Platform</label>
                        <select id="prodPlatform" class="w-full px-3 py-2 border rounded text-sm">
                            <option value="drip">Drip Client</option>
                            <option value="hg">HG Cheats</option>
                            <option value="dark">Dark Patch</option>
                            <option value="pato">Pato Team</option>
                        </select>
                    </div>
                    <div class="flex items-center">
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="prodVisible" class="mr-2" checked> Visible
                        </label>
                    </div>
                    <div class="flex gap-2">
                        <button id="saveProduct" class="bg-green-600 text-white px-4 py-2 rounded text-sm">Save</button>
                        <button id="cancelProduct" class="bg-gray-400 text-white px-4 py-2 rounded text-sm">Cancel</button>
                    </div>
                </div>
                <input type="hidden" id="editProdId" value="">
            </div>

            <!-- Products Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full border">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2">Name</th>
                            <th class="px-4 py-2">Price</th>
                            <th class="px-4 py-2">Order</th>
                            <th class="px-4 py-2">Platform</th>
                            <th class="px-4 py-2">Visible</th>
                            <th class="px-4 py-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable"></tbody>
                </table>
            </div>
            <p id="productsMessage" class="text-sm mt-2"></p>
        </div>

        <!-- Admin Users Section -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-users text-green-500 mr-2"></i>Admin Users</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <input type="email" id="adminEmail" placeholder="Admin Email" class="border rounded-lg px-3 py-2">
                <input type="text" id="adminRole" placeholder="Role (super_admin/admin)" class="border rounded-lg px-3 py-2" value="admin">
                <button id="addAdminBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Add Admin</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full border">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2">Email</th>
                            <th class="px-4 py-2">Role</th>
                            <th class="px-4 py-2">Created At</th>
                            <th class="px-4 py-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminUsersTable"></tbody>
                </table>
            </div>
            <p id="adminMessage" class="text-sm mt-2"></p>
        </div>
    </div>

    <!-- ========== ‡¶®‡¶∏‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü: JS ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ (‡¶Æ‡ßÇ‡¶≤ ‡¶∏‡¶æ‡¶á‡¶ü ‡¶•‡ßá‡¶ï‡ßá) ========== -->
    <noscript>
        <style>
            body { display: none !important; }
            html { 
                background: #000 !important; 
                height: 100% !important;
                overflow: hidden !important;
            }
        </style>
        <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;color:#ff0000;display:flex;align-items:center;justify-content:center;z-index:999999;font-family:monospace;text-align:center;flex-direction:column;">
            <div style="animation: pulse 1s infinite;">
                <h1 style="font-size:120px;margin:0;text-shadow:0 0 20px #ff0000;">üñï</h1>
                <h1 style="font-size:72px;margin:20px 0;letter-spacing:10px;">JavaScript is DISABLED</h1>
                <p style="font-size:24px;margin:20px 0;color:#fff;">Nice try, script kiddie</p>
                <p style="font-size:16px;color:#666;margin-top:30px;">Enable JavaScript to access this site</p>
            </div>
        </div>
        <style>
            @keyframes pulse {
                0%, 100% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.1); opacity: 0.8; }
            }
        </style>
    </noscript>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, get, set, update, remove, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // ================== üîí ‡¶è‡¶®‡¶ï‡ßã‡¶°‡ßá‡¶° ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó (‡¶Æ‡ßÇ‡¶≤ ‡¶∏‡¶æ‡¶á‡¶ü‡ßá‡¶∞ ‡¶ï‡ßå‡¶∂‡¶≤) ==================
        const encodedFirebaseConfig = "ewogICJhcGlLZXkiOiAiQUl6YVN5QXk0U1Q5QTRLVUJ6UXB1TnBqZEQ2YVU0MHM4cDFZTkVnIiwKICAiYXV0aERvbWFpbiI6ICJ0b3AtdXAtNGRiMDEuZmlyZWJhc2VhcHAuY29tIiwKICAiZGF0YWJhc2VVUkwiOiAiaHR0cHM6Ly90b3AtdXAtNGRiMDEtZGVmYXVsdC1ydGRiLmFzaWEtc291dGhlYXN0MS5maXJlYmFzZWRhdGFiYXNlLmFwcCIsCiAgInByb2plY3RJZCI6ICJ0b3AtdXAtNGRiMDEiLAogICJzdG9yYWdlQnVja2V0IjogInRvcC11cC00ZGIwMS5hcHBzcG90LmNvbSIsCiAgIm1lc3NhZ2luZ1NlbmRlcklkIjogIjI2NDU0ODE5NzQ3MyIsCiAgImFwcElkIjogIjE6MjY0NTQ4MTk3NDczOndlYjoxN2E1ZjFiNTYyMmQ0NjRmNWQ3NjIwIgp9";

        // ‡¶¨‡ßá‡¶∏‡ß¨‡ß™ ‡¶°‡¶ø‡¶ï‡ßã‡¶° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        function decodeBase64(str) {
            try {
                return JSON.parse(atob(str));
            } catch (e) {
                console.error("Decoding error", e);
                return null;
            }
        }

        const firebaseConfig = decodeBase64(encodedFirebaseConfig);

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getDatabase(app);

        // DOM elements
        const loginCard = document.getElementById('loginCard');
        const adminDash = document.getElementById('adminDashboard');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmailSpan = document.getElementById('userEmail');
        
        // Platform tabs
        const platformTabs = document.querySelectorAll('.platform-tab');
        const currentPlatformSpan = document.getElementById('currentPlatform');
        const currentPlatformProductsSpan = document.getElementById('currentPlatformProducts');
        
        // Settings
        const videoLink = document.getElementById('videoLink');
        const downloadLink = document.getElementById('downloadLink');
        const redirectBase = document.getElementById('redirectBase');
        const saveSettings = document.getElementById('saveSettings');
        const settingsMessage = document.getElementById('settingsMessage');
        
        // Products
        const addProductBtn = document.getElementById('addProductBtn');
        const productForm = document.getElementById('productForm');
        const formTitle = document.getElementById('formTitle');
        const prodName = document.getElementById('prodName');
        const prodPrice = document.getElementById('prodPrice');
        const prodOrder = document.getElementById('prodOrder');
        const prodPlatform = document.getElementById('prodPlatform');
        const prodVisible = document.getElementById('prodVisible');
        const editProdId = document.getElementById('editProdId');
        const saveProduct = document.getElementById('saveProduct');
        const cancelProduct = document.getElementById('cancelProduct');
        const productsTable = document.getElementById('productsTable');
        const productsMessage = document.getElementById('productsMessage');
        
        // Admin Users
        const adminEmail = document.getElementById('adminEmail');
        const adminRole = document.getElementById('adminRole');
        const addAdminBtn = document.getElementById('addAdminBtn');
        const adminUsersTable = document.getElementById('adminUsersTable');
        const adminMessage = document.getElementById('adminMessage');

        // State
        let currentUser = null;
        let currentPlatform = 'drip';

        // ================== üîí ‡¶Æ‡ßÇ‡¶≤ ‡¶∏‡¶æ‡¶á‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶°‡ßá‡¶≠ ‡¶ü‡ßÅ‡¶≤‡¶∏ ‡¶°‡¶ø‡¶ü‡ßá‡¶ï‡¶∂‡¶® + ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ==================
        (function() {
            'use strict';
            
            const CONFIG = {
                REDIRECT_URL: 'https://easy-premium.com/Privacy,Refund-Policy,Terms-Of-Service.html' // ‡¶Ø‡ßá ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶Ø‡¶º ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá
            };
            
            let devToolsOpened = false;
            function detectDevTools() {
                const start = performance.now();
                debugger; // ‡¶°‡¶ø‡¶¨‡¶æ‡¶ó‡¶æ‡¶∞ ‡¶ü‡ßç‡¶∞‡¶ø‡¶ó‡¶æ‡¶∞
                const end = performance.now();
                
                if (end - start > 100) {
                    if (!devToolsOpened) {
                        devToolsOpened = true;
                        // ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü
                        window.location.href = CONFIG.REDIRECT_URL;
                    }
                    return true;
                }
                return false;
            }
            
            // ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ßß ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
            setInterval(detectDevTools, 1000);
            setTimeout(detectDevTools, 500);
        })();

        // ================== üîí XSS ‡¶™‡ßç‡¶∞‡ßã‡¶ü‡ßá‡¶ï‡¶∂‡¶®: ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶∏‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶ü‡¶æ‡¶á‡¶ú (‡¶Æ‡ßÇ‡¶≤ ‡¶∏‡¶æ‡¶á‡¶ü ‡¶•‡ßá‡¶ï‡ßá) ==================
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;')
                .replace(/\//g, '&#x2F;')
                .replace(/\\/g, '&#x5C;')
                .replace(/`/g, '&#96;')
                .replace(/=/g, '&#61;');
        }

        // ================== üîí ‡¶ï‡ßÄ‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶∂‡¶∞‡ßç‡¶ü‡¶ï‡¶æ‡¶ü ‡¶¨‡ßç‡¶≤‡¶ï (‡¶Æ‡ßÇ‡¶≤ ‡¶∏‡¶æ‡¶á‡¶ü ‡¶•‡ßá‡¶ï‡ßá) ==================
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.keyCode === 85) { e.preventDefault(); return false; } // Ctrl+U
            if (e.ctrlKey && e.keyCode === 83) { e.preventDefault(); return false; } // Ctrl+S
            if (e.ctrlKey && e.shiftKey && e.keyCode === 73) { e.preventDefault(); return false; } // Ctrl+Shift+I
            if (e.keyCode === 123) { e.preventDefault(); return false; } // F12
        });

        // ================== üîí ‡¶∞‡¶æ‡¶á‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶™‡ßç‡¶∞‡ßã‡¶ü‡ßá‡¶ï‡¶∂‡¶® (‡¶Æ‡ßÇ‡¶≤ ‡¶∏‡¶æ‡¶á‡¶ü ‡¶•‡ßá‡¶ï‡ßá) ==================
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        document.addEventListener('mousedown', function(e) {
            if (e.button === 2) {
                e.preventDefault();
                return false;
            }
        });
        
        document.addEventListener('touchstart', function(e) {
            let touchTimer;
            const handleTouchEnd = function() {
                clearTimeout(touchTimer);
                document.removeEventListener('touchend', handleTouchEnd);
            };
            if (e.touches.length === 1) {
                touchTimer = setTimeout(function() {
                    e.preventDefault();
                }, 500);
                document.addEventListener('touchend', handleTouchEnd, { once: true });
            }
        }, { passive: false });

        // Platform tabs click handler
        platformTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                platformTabs.forEach(t => t.classList.remove('tab-active', 'bg-blue-600', 'text-white'));
                tab.classList.add('tab-active', 'bg-blue-600', 'text-white');
                currentPlatform = tab.dataset.platform;
                
                const platformNames = { drip: 'Drip Client', hg: 'HG Cheats', dark: 'Dark Patch', pato: 'Pato Team' };
                currentPlatformSpan.textContent = platformNames[currentPlatform];
                currentPlatformProductsSpan.textContent = platformNames[currentPlatform];
                
                prodPlatform.value = currentPlatform;
                loadSettings();
                loadProducts();
            });
        });

        // Check if user is admin
        async function isAdmin(user) {
            if (!user) return false;
            try {
                const adminRef = ref(db, `__collections__/adminUsers/${user.uid}`);
                const snapshot = await get(adminRef);
                return snapshot.exists();
            } catch (e) {
                console.error('Admin check error:', e);
                return false;
            }
        }

        // Auth state
        onAuthStateChanged(auth, async (user) => {
            if (user && await isAdmin(user)) {
                currentUser = user;
                loginCard.classList.add('hidden');
                adminDash.classList.remove('hidden');
                userEmailSpan.textContent = user.email;
                
                // Load data
                loadSettings();
                loadProducts();
                loadAdminUsers();
            } else if (user && !await isAdmin(user)) {
                await signOut(auth);
                loginError.textContent = 'You are not authorized as admin.';
                loginCard.classList.remove('hidden');
                adminDash.classList.add('hidden');
            } else {
                loginCard.classList.remove('hidden');
                adminDash.classList.add('hidden');
            }
        });

        googleLoginBtn.addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                const adminRef = ref(db, `__collections__/adminUsers/${user.uid}`);
                const snapshot = await get(adminRef);
                
                if (!snapshot.exists()) {
                    await signOut(auth);
                    loginError.textContent = 'You are not authorized as admin.';
                } else {
                    loginError.textContent = '';
                }
            } catch (err) {
                loginError.textContent = err.message;
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // Load platform-specific settings
        async function loadSettings() {
            try {
                const settingsRef = ref(db, `__collections__/settings/${currentPlatform}`);
                const snapshot = await get(settingsRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    videoLink.value = data.videoLink || '';
                    downloadLink.value = data.downloadLink || '';
                    redirectBase.value = data.redirectBaseUrl || '';
                } else {
                    videoLink.value = '';
                    downloadLink.value = '';
                    redirectBase.value = '';
                }
                settingsMessage.innerHTML = '';
            } catch (e) {
                settingsMessage.innerHTML = '<span class="text-red-500">Load error: ' + e.message + '</span>';
            }
        }

        // Save platform-specific settings
        saveSettings.addEventListener('click', async () => {
            try {
                await set(ref(db, `__collections__/settings/${currentPlatform}`), {
                    videoLink: videoLink.value,
                    downloadLink: downloadLink.value,
                    redirectBaseUrl: redirectBase.value
                });
                settingsMessage.innerHTML = '<span class="text-green-500">Settings saved successfully!</span>';
            } catch (e) {
                settingsMessage.innerHTML = '<span class="text-red-500">Error: ' + e.message + '</span>';
            }
        });

        // Load products for current platform
        async function loadProducts() {
            try {
                const productsRef = ref(db, '__collections__/products');
                const snapshot = await get(productsRef);
                
                if (!snapshot.exists()) {
                    productsTable.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-gray-400">No products yet. Add one.</td></tr>';
                    return;
                }

                const productsData = snapshot.val();
                const products = Object.entries(productsData)
                    .map(([id, data]) => ({ id, ...data }))
                    .filter(p => p.platform === currentPlatform)
                    .sort((a, b) => (a.order || 0) - (b.order || 0));

                if (products.length === 0) {
                    productsTable.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-gray-400">No products for this platform. Add one.</td></tr>';
                    return;
                }

                let html = '';
                products.forEach(p => {
                    html += `<tr>
                        <td class="px-4 py-3">${escapeHtml(p.name)}</td>
                        <td class="px-4 py-3">‡ß≥${p.price}</td>
                        <td class="px-4 py-3">${p.order || 0}</td>
                        <td class="px-4 py-3">${p.platform}</td>
                        <td class="px-4 py-3">${p.visible ? '‚úÖ' : '‚ùå'}</td>
                        <td class="px-4 py-3">
                            <button class="edit-product text-blue-600 mx-1" data-id="${p.id}"><i class="fas fa-edit"></i></button>
                            <button class="toggle-visibility text-orange-600 mx-1" data-id="${p.id}" data-visible="${p.visible}"><i class="fas ${p.visible ? 'fa-eye-slash' : 'fa-eye'}"></i></button>
                            <button class="delete-product text-red-600 mx-1" data-id="${p.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
                
                productsTable.innerHTML = html;
                attachProductActions();
                productsMessage.innerHTML = '';
            } catch (e) {
                productsMessage.innerHTML = '<span class="text-red-500">Load error: ' + e.message + '</span>';
            }
        }

        // XSS ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶æ‡¶Å‡¶ö‡¶§‡ßá escapeHtml ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        function escapeHtml(unsafe) {
            return String(unsafe).replace(/[&<>"]/g, function(m) {
                if (m === '&') return '&amp;';
                if (m === '<') return '&lt;';
                if (m === '>') return '&gt;';
                if (m === '"') return '&quot;';
                return m;
            });
        }

        function attachProductActions() {
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', () => editProduct(btn.dataset.id));
            });
            document.querySelectorAll('.toggle-visibility').forEach(btn => {
                btn.addEventListener('click', () => toggleVisibility(btn.dataset.id, btn.dataset.visible === 'true'));
            });
            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', () => deleteProduct(btn.dataset.id));
            });
        }

        addProductBtn.addEventListener('click', () => {
            productForm.classList.remove('hidden');
            formTitle.textContent = '‚ûï Add Product';
            prodName.value = '';
            prodPrice.value = '';
            prodOrder.value = '0';
            prodPlatform.value = currentPlatform;
            prodVisible.checked = true;
            editProdId.value = '';
        });

        cancelProduct.addEventListener('click', () => {
            productForm.classList.add('hidden');
        });

        saveProduct.addEventListener('click', async () => {
            const name = prodName.value.trim();
            const price = parseFloat(prodPrice.value);
            const order = parseInt(prodOrder.value) || 0;
            const platform = prodPlatform.value;
            const visible = prodVisible.checked;
            const id = editProdId.value;

            if (!name || isNaN(price) || price <= 0) {
                alert('Please enter a valid name and price');
                return;
            }

            const data = { name, price, order, platform, visible };
            const productsRef = ref(db, '__collections__/products');

            try {
                if (id) {
                    await set(ref(db, `__collections__/products/${id}`), data);
                } else {
                    const newRef = push(productsRef);
                    await set(newRef, data);
                }
                
                productForm.classList.add('hidden');
                editProdId.value = '';
                await loadProducts();
            } catch (e) {
                console.error('Save error:', e);
                alert('Error: ' + e.message);
            }
        });

        async function editProduct(id) {
            const productRef = ref(db, `__collections__/products/${id}`);
            const snapshot = await get(productRef);
            
            if (snapshot.exists()) {
                const p = snapshot.val();
                prodName.value = p.name || '';
                prodPrice.value = p.price || '';
                prodOrder.value = p.order || 0;
                prodPlatform.value = p.platform || currentPlatform;
                prodVisible.checked = p.visible !== false;
                editProdId.value = id;
                formTitle.textContent = '‚úèÔ∏è Edit Product';
                productForm.classList.remove('hidden');
            }
        }

        async function toggleVisibility(id, current) {
            await set(ref(db, `__collections__/products/${id}/visible`), !current);
            await loadProducts();
        }

        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                await remove(ref(db, `__collections__/products/${id}`));
                await loadProducts();
            }
        }

        // Load admin users
        async function loadAdminUsers() {
            try {
                const adminRef = ref(db, '__collections__/adminUsers');
                const snapshot = await get(adminRef);
                
                if (!snapshot.exists()) {
                    adminUsersTable.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-gray-400">No admin users yet.</td></tr>';
                    return;
                }

                const admins = Object.entries(snapshot.val()).map(([uid, data]) => ({ uid, ...data }));
                
                let html = '';
                admins.forEach(admin => {
                    html += `<tr>
                        <td class="px-4 py-3">${escapeHtml(admin.email || '')}</td>
                        <td class="px-4 py-3">${escapeHtml(admin.role || 'admin')}</td>
                        <td class="px-4 py-3">${admin.createdAt || 'N/A'}</td>
                        <td class="px-4 py-3">
                            <button class="delete-admin text-red-600" data-uid="${admin.uid}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
                
                adminUsersTable.innerHTML = html;
                
                document.querySelectorAll('.delete-admin').forEach(btn => {
                    btn.addEventListener('click', () => deleteAdmin(btn.dataset.uid));
                });
                
                adminMessage.innerHTML = '';
            } catch (e) {
                adminMessage.innerHTML = '<span class="text-red-500">Load error: ' + e.message + '</span>';
            }
        }

        addAdminBtn.addEventListener('click', async () => {
            const email = adminEmail.value.trim();
            const role = adminRole.value.trim() || 'admin';
            
            if (!email) {
                alert('Please enter an email');
                return;
            }

            try {
                // Generate a unique ID for the admin (using email as key)
                const adminId = email.replace(/[.#$\[\]]/g, '_');
                await set(ref(db, `__collections__/adminUsers/${adminId}`), {
                    email: email,
                    role: role,
                    createdAt: new Date().toISOString().split('T')[0]
                });
                
                adminEmail.value = '';
                adminRole.value = 'admin';
                await loadAdminUsers();
                adminMessage.innerHTML = '<span class="text-green-500">Admin added successfully!</span>';
            } catch (e) {
                adminMessage.innerHTML = '<span class="text-red-500">Error: ' + e.message + '</span>';
            }
        });

        async function deleteAdmin(uid) {
            if (confirm('Are you sure you want to remove this admin?')) {
                try {
                    await remove(ref(db, `__collections__/adminUsers/${uid}`));
                    await loadAdminUsers();
                    adminMessage.innerHTML = '<span class="text-green-500">Admin removed successfully!</span>';
                } catch (e) {
                    adminMessage.innerHTML = '<span class="text-red-500">Error: ' + e.message + '</span>';
                }
            }
        }
    </script>
</body>
</html>
