<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Drip Client Manager</title>
    <!-- Tailwind for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK (modular) -->
    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
            }
        }
    </script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .hidden { display: none; }
        .editing { background-color: #fef9e7; }
    </style>
</head>
<body class="bg-gray-100 p-4 font-sans">

<div id="loginContainer" class="max-w-md mx-auto mt-20 bg-white p-6 rounded shadow">
    <h2 class="text-2xl font-bold mb-4 text-center">Admin Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" class="w-full p-2 border rounded mb-3">
    <input type="password" id="loginPassword" placeholder="Password" class="w-full p-2 border rounded mb-3">
    <button id="loginBtn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Login</button>
    <p id="loginError" class="text-red-500 text-sm mt-2 text-center"></p>
    <p class="text-xs text-gray-500 mt-4 text-center">Use Firebase Auth (Email/Password). Create user in Firebase Console first.</p>
</div>

<div id="adminPanel" class="hidden max-w-6xl mx-auto">
    <!-- Header with logout -->
    <div class="flex justify-between items-center bg-white p-4 rounded shadow mb-4">
        <h1 class="text-2xl font-bold">üî• Drip Client Admin</h1>
        <button id="logoutBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
    </div>

    <!-- Settings Card -->
    <div class="bg-white p-4 rounded shadow mb-4">
        <h2 class="text-xl font-semibold mb-3"><i class="fas fa-cog mr-2"></i>Global Settings</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Video Link</label>
                <input type="url" id="videoLinkInput" placeholder="https://youtu.be/..." class="w-full p-2 border rounded">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Download Link</label>
                <input type="url" id="downloadLinkInput" placeholder="https://t.me/..." class="w-full p-2 border rounded">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Redirect Base URL</label>
                <input type="url" id="redirectBaseInput" placeholder="https://t.me/yourbot?start=" class="w-full p-2 border rounded">
            </div>
        </div>
        <button id="saveSettingsBtn" class="mt-3 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"><i class="fas fa-save mr-2"></i>Save Settings</button>
        <p id="settingsMessage" class="text-sm mt-2"></p>
    </div>

    <!-- Products Card -->
    <div class="bg-white p-4 rounded shadow">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-xl font-semibold"><i class="fas fa-box mr-2"></i>Products (Packages)</h2>
            <button id="addProductBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"><i class="fas fa-plus mr-2"></i>Add New</button>
        </div>

        <!-- Product form (hidden by default) -->
        <div id="productForm" class="hidden bg-gray-50 p-4 border rounded mb-4">
            <h3 class="font-medium mb-2" id="formTitle">Add Product</h3>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                <div>
                    <label class="block text-xs text-gray-600">Name</label>
                    <input type="text" id="productName" class="w-full p-2 border rounded" placeholder="e.g. Drip Apk 7 Days">
                </div>
                <div>
                    <label class="block text-xs text-gray-600">Price (‡ß≥)</label>
                    <input type="number" id="productPrice" class="w-full p-2 border rounded" placeholder="350">
                </div>
                <div>
                    <label class="block text-xs text-gray-600">Order (sort)</label>
                    <input type="number" id="productOrder" class="w-full p-2 border rounded" placeholder="1">
                </div>
                <div class="flex items-center">
                    <label class="flex items-center">
                        <input type="checkbox" id="productVisible" class="mr-2" checked> Visible
                    </label>
                </div>
                <div class="flex gap-2">
                    <button id="saveProductBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Save</button>
                    <button id="cancelProductBtn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
                </div>
            </div>
            <input type="hidden" id="editProductId" value="">
        </div>

        <!-- Products table -->
        <div id="productsList" class="overflow-x-auto">
            <table class="w-full border">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="p-2 text-left">Name</th>
                        <th class="p-2 text-left">Price</th>
                        <th class="p-2 text-left">Order</th>
                        <th class="p-2 text-left">Visible</th>
                        <th class="p-2 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    <!-- populated by JS -->
                </tbody>
            </table>
        </div>
        <p id="productsMessage" class="text-sm mt-2"></p>
    </div>
</div>

<script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // Firebase config (provided by user)
    const firebaseConfig = {
        apiKey: "AIzaSyAy4ST9A4KUBzQpuNpjdD6aU40s8p1YNEg",
        authDomain: "top-up-4db01.firebaseapp.com",
        databaseURL: "https://top-up-4db01-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "top-up-4db01",
        storageBucket: "top-up-4db01.appspot.com",
        messagingSenderId: "264548197473",
        appId: "1:264548197473:web:17a5f1b5622d464f5d7620",
        measurementId: "G-ZEMKJ3BD0G"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM elements
    const loginContainer = document.getElementById('loginContainer');
    const adminPanel = document.getElementById('adminPanel');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');

    // Settings elements
    const videoLinkInput = document.getElementById('videoLinkInput');
    const downloadLinkInput = document.getElementById('downloadLinkInput');
    const redirectBaseInput = document.getElementById('redirectBaseInput');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const settingsMessage = document.getElementById('settingsMessage');

    // Product elements
    const addProductBtn = document.getElementById('addProductBtn');
    const productForm = document.getElementById('productForm');
    const formTitle = document.getElementById('formTitle');
    const productName = document.getElementById('productName');
    const productPrice = document.getElementById('productPrice');
    const productOrder = document.getElementById('productOrder');
    const productVisible = document.getElementById('productVisible');
    const editProductId = document.getElementById('editProductId');
    const saveProductBtn = document.getElementById('saveProductBtn');
    const cancelProductBtn = document.getElementById('cancelProductBtn');
    const productsTableBody = document.getElementById('productsTableBody');
    const productsMessage = document.getElementById('productsMessage');

    // ---------- Auth State Observer ----------
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // User is logged in
            loginContainer.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            await loadSettings();
            await loadProducts();
        } else {
            // No user, show login
            loginContainer.classList.remove('hidden');
            adminPanel.classList.add('hidden');
        }
    });

    // ---------- Login ----------
    loginBtn.addEventListener('click', async () => {
        const email = loginEmail.value.trim();
        const password = loginPassword.value.trim();
        if (!email || !password) {
            loginError.textContent = 'Email and password required';
            return;
        }
        try {
            await signInWithEmailAndPassword(auth, email, password);
            loginError.textContent = '';
        } catch (error) {
            loginError.textContent = error.message;
        }
    });

    // ---------- Logout ----------
    logoutBtn.addEventListener('click', async () => {
        await signOut(auth);
    });

    // ---------- Load Settings from Firestore (doc: settings/general) ----------
    async function loadSettings() {
        try {
            const settingsRef = doc(db, 'settings', 'general');
            const snap = await getDoc(settingsRef);
            if (snap.exists()) {
                const data = snap.data();
                videoLinkInput.value = data.videoLink || '';
                downloadLinkInput.value = data.downloadLink || '';
                redirectBaseInput.value = data.redirectBaseUrl || '';
            } else {
                // Set defaults
                videoLinkInput.value = 'https://youtu.be/nZ2maK61xeY';
                downloadLinkInput.value = 'https://t.me/g_tools_official/1872';
                redirectBaseInput.value = 'https://t.me/yourchannel?start=';
            }
        } catch (e) {
            console.error('loadSettings error', e);
        }
    }

    // ---------- Save Settings ----------
    saveSettingsBtn.addEventListener('click', async () => {
        const videoLink = videoLinkInput.value.trim();
        const downloadLink = downloadLinkInput.value.trim();
        const redirectBaseUrl = redirectBaseInput.value.trim();

        if (!videoLink || !downloadLink || !redirectBaseUrl) {
            settingsMessage.textContent = 'All fields are required';
            settingsMessage.className = 'text-sm mt-2 text-red-500';
            return;
        }

        try {
            const settingsRef = doc(db, 'settings', 'general');
            await setDoc(settingsRef, {
                videoLink,
                downloadLink,
                redirectBaseUrl
            }, { merge: true });
            settingsMessage.textContent = 'Settings saved successfully!';
            settingsMessage.className = 'text-sm mt-2 text-green-500';
        } catch (e) {
            settingsMessage.textContent = 'Error: ' + e.message;
            settingsMessage.className = 'text-sm mt-2 text-red-500';
        }
    });

    // ---------- Load Products (ordered by 'order' field) ----------
    async function loadProducts() {
        try {
            const q = query(collection(db, 'products'), orderBy('order', 'asc'));
            const querySnapshot = await getDocs(q);
            const products = [];
            querySnapshot.forEach((docSnap) => {
                products.push({ id: docSnap.id, ...docSnap.data() });
            });
            renderProductsTable(products);
        } catch (e) {
            productsMessage.textContent = 'Error loading products: ' + e.message;
            productsMessage.className = 'text-sm mt-2 text-red-500';
        }
    }

    function renderProductsTable(products) {
        if (products.length === 0) {
            productsTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">No products found. Add one.</td></tr>';
            return;
        }
        let html = '';
        products.forEach(p => {
            html += `<tr class="border-b hover:bg-gray-50" data-id="${p.id}">
                <td class="p-2">${escapeHtml(p.name || '')}</td>
                <td class="p-2">‡ß≥${p.price || 0}</td>
                <td class="p-2">${p.order || 0}</td>
                <td class="p-2">${p.visible ? '‚úÖ Yes' : '‚ùå No'}</td>
                <td class="p-2 space-x-2">
                    <button class="editBtn text-blue-600 hover:text-blue-800" data-id="${p.id}"><i class="fas fa-edit"></i></button>
                    <button class="toggleVisibleBtn text-${p.visible ? 'orange' : 'green'}-600 hover:text-${p.visible ? 'orange' : 'green'}-800" data-id="${p.id}" data-visible="${p.visible}">
                        <i class="fas ${p.visible ? 'fa-eye-slash' : 'fa-eye'}"></i>
                    </button>
                    <button class="deleteBtn text-red-600 hover:text-red-800" data-id="${p.id}"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
        productsTableBody.innerHTML = html;

        // Attach event listeners
        document.querySelectorAll('.editBtn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = btn.dataset.id;
                editProduct(id);
            });
        });

        document.querySelectorAll('.toggleVisibleBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const id = btn.dataset.id;
                const currentlyVisible = btn.dataset.visible === 'true';
                await toggleProductVisibility(id, !currentlyVisible);
            });
        });

        document.querySelectorAll('.deleteBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                if (confirm('Are you sure you want to delete this product?')) {
                    const id = btn.dataset.id;
                    await deleteProduct(id);
                }
            });
        });
    }

    // Simple escape to prevent XSS
    function escapeHtml(unsafe) {
        return unsafe.replace(/[&<>"]/g, function(m) {
            if(m === '&') return '&amp;'; if(m === '<') return '&lt;'; if(m === '>') return '&gt;'; if(m === '"') return '&quot;';
            return m;
        });
    }

    // ---------- Product CRUD ----------
    function showProductForm(mode = 'add', productData = null) {
        productForm.classList.remove('hidden');
        if (mode === 'add') {
            formTitle.textContent = 'Add New Product';
            productName.value = '';
            productPrice.value = '';
            productOrder.value = '0';
            productVisible.checked = true;
            editProductId.value = '';
        } else {
            formTitle.textContent = 'Edit Product';
            productName.value = productData.name || '';
            productPrice.value = productData.price || 0;
            productOrder.value = productData.order || 0;
            productVisible.checked = productData.visible !== false;
            editProductId.value = productData.id;
        }
    }

    addProductBtn.addEventListener('click', () => {
        showProductForm('add');
    });

    cancelProductBtn.addEventListener('click', () => {
        productForm.classList.add('hidden');
    });

    saveProductBtn.addEventListener('click', async () => {
        const name = productName.value.trim();
        const price = parseFloat(productPrice.value);
        const order = parseInt(productOrder.value) || 0;
        const visible = productVisible.checked;
        const id = editProductId.value;

        if (!name || isNaN(price) || price <= 0) {
            alert('Name and valid price required');
            return;
        }

        const productData = {
            name,
            price,
            order,
            visible
        };

        try {
            if (id) {
                // Update existing
                const ref = doc(db, 'products', id);
                await updateDoc(ref, productData);
            } else {
                // Add new
                await addDoc(collection(db, 'products'), productData);
            }
            productForm.classList.add('hidden');
            await loadProducts();
        } catch (e) {
            alert('Error saving product: ' + e.message);
        }
    });

    async function editProduct(id) {
        try {
            const ref = doc(db, 'products', id);
            const snap = await getDoc(ref);
            if (snap.exists()) {
                const data = { id: snap.id, ...snap.data() };
                showProductForm('edit', data);
            } else {
                alert('Product not found');
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    }

    async function toggleProductVisibility(id, newVisible) {
        try {
            const ref = doc(db, 'products', id);
            await updateDoc(ref, { visible: newVisible });
            await loadProducts();
        } catch (e) {
            alert('Error toggling visibility: ' + e.message);
        }
    }

    async function deleteProduct(id) {
        try {
            await deleteDoc(doc(db, 'products', id));
            await loadProducts();
        } catch (e) {
            alert('Error deleting product: ' + e.message);
        }
    }

    // Also handle enter key on login
    loginPassword.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loginBtn.click();
    });
</script>

<!-- Note: You must create at least one user in Firebase Authentication (Email/Password) to log in. -->
<!-- Also ensure Firestore rules allow read/write only for authenticated users (or adjust as needed). -->
</body>
</html>
